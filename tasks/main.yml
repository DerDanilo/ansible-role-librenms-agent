---

- name: "Include {{ ansible_os_family }} Specific Variables"
  include_vars: "{{ ansible_os_family }}.yml"

- name: "{{ ansible_os_family }} Fmaily"
  include_tasks: "setup-{{ ansible_os_family }}.yml"

- name: Install Dependancies
  package:
    name: "{{ item }}"
    state: present
  with_flattened: "{{ librenms_agent_dependant_packages }}"

- name: Ensure Folders Exist
  file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: 0755
  with_items:
    - "{{ librenms_agent_snmp_scripts_dir }}"
    - "{{ librenms_agent_chcek_mk_dir }}"

- name: Update check_mk xinetd Config
  template:
    src: "xinetd-check_mk.j2"
    dest: "{{ librenms_agent_xinetd_dir }}/check_mk"
    owner: root
    group: root
    mode: 0644
  notify: Restart xinetd

- name: Install check_mk Scripts
  get_url:
    url: "{{ librenms_agent_check_mk_github_repo }}/{{ item }}"
    dest: "{{ librenms_agent_chcek_mk_dir }}/{{ item }}"
    force: "{{ librenms_agent_scripts_update }}"
    mode: 0755
  failed_when: false
  with_flattened: "{{ librenms_agent_check_mk_scripts }}"
  register: script_results

- name: Install check_mk Scripts with .sh
  get_url:
    url: "{{ librenms_agent_check_mk_github_repo }}/{{ item.item }.sh"
    dest: "{{ librenms_agent_chcek_mk_dir }}/{{ item.item }}"
    force: "{{ librenms_agent_scripts_update }}"
    mode: 0755
  with_items: "{{ script_results.results }}"
  loop_control:
    label: "{{ item.item }}"
  when: item.status_code is defined and item.status_code == 404

- name: Install snmp Scripts
  get_url:
    url: "{{ librenms_agent_snmp_github_repo }}/{{ item }}"
    dest: "{{ librenms_agent_snmp_scripts_dir }}/{{ item }}"
    force: "{{ librenms_agent_scripts_update }}"
    mode: 0755
  failed_when: false
  with_flattened: "{{ librenms_agent_snmp_scripts }}"
  register: script_results

- name: Install snmp Scripts with .sh
  get_url:
    url: "{{ librenms_agent_snmp_github_repo }}/{{ item.item }}.sh"
    dest: "{{ librenms_agent_snmp_scripts_dir }}/{{ item.item }}"
    force: "{{ librenms_agent_scripts_update }}"
    mode: 0755
  with_items: "{{ script_results.results }}"
  loop_control:
    label: "{{ item.item }}"
  when: item.status_code is defined and item.status_code == 404

- name: mysql module config
  when: "'mysql' in librenms_agent_check_mk_scripts or 'mysql' in librenms_agent_snmp_scripts"
  block:
    - name: Install Dependancies for mysql script
      package:
        name: "{{ item }}"
        state: present
      with_items:
        - php-cli
        - php-mysql

    - name: MySQL Config check_mk
      template:
        src: "mysql.cnf.j2"
        dest: "{{ librenms_agent_chcek_mk_dir }}/mysql.cnf"
        owner:
        group:
        mode:
      when: "'mysql' in librenms_agent_check_mk_scripts"

    - name: MySQL Config snmp
      template:
        src: "mysql.cnf.j2"
        dest: "{{ librenms_agent_snmp_scripts_dir }}/mysql.cnf"
        owner:
        group:
        mode:
      when: "'mysql' in librenms_agent_snmp_scripts"

- name: Disable snmp Logging
  replace:
    path: /lib/systemd/system/snmpd.service
    regexp: '(\s+)-Lsd(\s+.*)?$'
    replace: '\1-LSed\2'
  when: librenms_agent_snmp_no_logging
  notify: Reload snmpd

- name: Configure snmp
  template:
    src: "snmpd.conf.j2"
    dest: "{{ librenms_agent_snmp_dir }}/snmpd.conf"
    owner: root
    group: root
    mode: 0644
  notify: Restart snmpd
